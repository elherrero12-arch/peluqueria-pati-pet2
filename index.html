<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Agenda profesional para peluquer√≠a canina Pati-pet. Gestiona turnos, clientes y estad√≠sticas.">
    <meta name="theme-color" content="#ffab91">
    <title>Peluquer√≠a Canina Pati-pet - Agenda Profesional</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png" type="image/png">
    <style>
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #f9f7ff 0%, #e3f2fd 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Encabezado mejorado */
        .header-container {
            text-align: center;
            margin: 0 auto 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 102, 204, 0.1);
            max-width: 800px;
            border: 2px solid #ffccd5;
        }
        
        .paws-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 10px 0;
            font-size: 20px;
        }
        
        .main-title {
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            color: #5d4037;
            font-size: 1.8rem;
            margin: 10px 0;
        }
        
        .subtitle {
            color: #8d6e63;
            font-size: 1.1rem;
            font-style: italic;
            margin-bottom: 10px;
        }
        
        /* Indicador offline */
        .offline-indicator {
            display: none;
            background: #ff7043;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .offline-indicator.show {
            display: block;
        }
        
        /* Navegacion */
        .nav { 
            display: flex; 
            background: #5d4037;
            margin-bottom: 25px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(93, 64, 55, 0.2);
        }
        
        .nav button { 
            flex: 1; 
            padding: 18px 10px; 
            border: none; 
            background: #8d6e63; 
            color: white; 
            cursor: pointer; 
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .nav button:hover { 
            background: #a1887f; 
            transform: translateY(-2px);
        }
        
        .nav button.active { 
            background: #ffab91; 
            color: #5d4037;
            box-shadow: inset 0 -3px 0 #ff8a65;
        }
        
        /* Paneles */
        .panel { 
            display: none; 
            background: white; 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
        }
        
        .panel.active { 
            display: block; 
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Calendario Mensual */
        .mes-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ffccd5;
        }
        
        .mes-header h2 {
            color: #5d4037;
            font-size: 1.8rem;
        }
        
        .dias-semana { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            text-align: center; 
            font-weight: bold; 
            margin-bottom: 15px;
            color: #8d6e63;
            padding: 10px 0;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        .dias-mes { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 8px; 
        }
        
        .dia { 
            padding: 12px 5px; 
            border: 1px solid #e0e0e0; 
            text-align: center; 
            cursor: pointer; 
            min-height: 70px;
            border-radius: 8px;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            position: relative;
            background: #fafafa;
        }
        
        .dia:hover { 
            background: #e3f2fd; 
            transform: scale(1.03);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        
        .dia.hoy { 
            background: #ffe0b2; 
            border-color: #ffab91;
            font-weight: bold;
        }
        
        .dia.pasado {
            background: #f5f5f5;
            color: #9e9e9e;
            cursor: not-allowed;
        }
        
        .dia.con-turno { 
            background: #ffebee; 
            position: relative; 
        }
        
        .dia.con-turno::after { 
            content: "üêæ"; 
            font-size: 12px;
            position: absolute; 
            top: 5px; 
            right: 5px; 
        }
        
        .turno-count {
            font-size: 10px;
            color: #d32f2f;
            margin-top: 5px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            padding: 1px 5px;
            align-self: center;
        }
        
        /* Formularios */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: bold;
            color: #5d4037;
        }
        
        input, select, textarea { 
            width: 100%; 
            padding: 14px; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #ffab91;
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 171, 145, 0.2);
        }
        
        .btn { 
            background: linear-gradient(to right, #ffab91, #ff8a65); 
            color: white; 
            padding: 15px 25px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(255, 138, 101, 0.2);
        }
        
        .btn:hover { 
            background: linear-gradient(to right, #ff8a65, #ff7043); 
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(255, 138, 101, 0.3);
        }
        
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Listas */
        .lista-turnos { 
            margin-top: 20px; 
        }
        
        .turno-item { 
            border-left: 5px solid #ffab91; 
            padding: 20px; 
            margin-bottom: 15px; 
            background: #f9f9f9;
            border-radius: 0 10px 10px 0;
            transition: all 0.3s ease;
        }
        
        .turno-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .turno-item.hoy { 
            border-left-color: #ff7043; 
            background: #fff3e0; 
        }
        
        .tag-pago { 
            display: inline-block; 
            padding: 5px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            margin-left: 10px;
            font-weight: bold;
        }
        
        .mp { 
            background: #00a650; 
            color: white; 
        }
        
        .nx { 
            background: #5c6bc0; 
            color: white; 
        }
        
        .efect { 
            background: #ff9800; 
            color: white; 
        }
        
        /* Botones de acci√≥n */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .action-buttons button {
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }
        
        .edit-btn {
            background: #bbdefb;
            color: #1565c0;
        }
        
        .delete-btn {
            background: #ffcdd2;
            color: #c62828;
        }
        
        .whatsapp-btn {
            background: #25D366;
            color: white;
        }
        
        .share-btn {
            background: #FF9800;
            color: white;
        }
        
        .edit-btn:hover {
            background: #90caf9;
        }
        
        .delete-btn:hover {
            background: #ef9a9a;
        }
        
        .whatsapp-btn:hover {
            background: #128C7E;
        }
        
        .share-btn:hover {
            background: #F57C00;
        }
        
        /* Estadisticas */
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin: 25px 0; 
        }
        
        .stat-box { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            text-align: center; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            border-top: 5px solid #ffab91;
            transition: all 0.3s ease;
        }
        
        .stat-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        
        .stat-box h3 { 
            margin: 0 0 15px 0; 
            color: #8d6e63;
            font-size: 1rem;
        }
        
        .stat-box .valor { 
            font-size: 28px; 
            font-weight: bold; 
            color: #5d4037; 
        }
        
        /* Header responsive para vista d√≠a */
        .day-header-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .day-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .day-header-bottom {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .day-header-bottom .btn {
            flex: 1;
            min-width: 150px;
        }
        
        /* Utilidades */
        .oculto { 
            display: none; 
        }
        
        .datalist-items { 
            max-height: 200px; 
            overflow-y: auto; 
        }
        
        .mes-header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .mes-header-buttons button {
            padding: 10px 18px;
            background: #ffccd5;
            color: #5d4037;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .mes-header-buttons button:hover {
            background: #ffab91;
        }
        
        .telefono-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            color: #5d4037;
        }
        
        .notas-info {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
            border-left: 3px solid #ffab91;
        }
        
        /* Instalar App Banner */
        .install-banner {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 15px;
            max-width: 90%;
        }
        
        .install-banner.show {
            display: flex;
            animation: slideUp 0.5s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        .install-btn {
            background: #ff7043;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .close-install {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .nav {
                flex-wrap: wrap;
            }
            
            .nav button {
                flex: 1 0 33%;
                padding: 15px 5px;
                font-size: 13px;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .day-header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .day-header-bottom {
                width: 100%;
            }
            
            .day-header-bottom .btn {
                min-width: 100%;
            }
            
            .mes-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .mes-header-buttons {
                width: 100%;
                justify-content: space-between;
            }
            
            .action-buttons button {
                min-width: calc(50% - 5px);
            }
        }
        
        @media (max-width: 480px) {
            .stats {
                grid-template-columns: 1fr;
            }
            
            .nav button {
                flex: 1 0 50%;
            }
            
            .action-buttons button {
                min-width: 100%;
            }
            
            .panel {
                padding: 20px 15px;
            }
            
            .main-title {
                font-size: 1.5rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .install-banner {
                flex-direction: column;
                text-align: center;
            }
        }
        
        /* Animaciones */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .shake {
            animation: shake 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <!-- Indicador de conexi√≥n -->
    <div id="offlineIndicator" class="offline-indicator">
        ‚ö†Ô∏è Modo offline - Los datos se guardar√°n localmente
    </div>
    
    <!-- Banner para instalar app -->
    <div id="installBanner" class="install-banner">
        <span>üì± Instalar Pati-pet App para usar offline</span>
        <button id="installBtn" class="install-btn">Instalar</button>
        <button id="closeInstall" class="close-install">‚úï</button>
    </div>
    
    <!-- Encabezado mejorado -->
    <div class="header-container">
        <div class="paws-row">
            <span>üêæ</span><span>üêæ</span><span>üêæ</span>
        </div>
        <h1 class="main-title">Peluquer√≠a Canina Pati-pet</h1>
        <div class="paws-row">
            <span>üêæ</span><span>üêæ</span><span>üêæ</span>
        </div>
        <p class="subtitle">Agenda Profesional para Mascotas</p>
        <p style="font-size: 0.9rem; color: #9e9e9e; margin-top: 5px;">üíæ Datos guardados localmente | üì± Usa offline</p>
    </div>
    
    <!-- Navegacion -->
    <div class="nav">
        <button onclick="mostrarPanel('panel-mes')" class="active">üìÖ Mes</button>
        <button onclick="mostrarPanel('panel-semana')">üìã Semana</button>
        <button onclick="mostrarPanel('panel-dia')">üêï D√≠a</button>
        <button onclick="mostrarPanel('panel-nuevo')">‚ûï Nuevo Turno</button>
        <button onclick="mostrarPanel('panel-clientes')">üë• Clientes</button>
        <button onclick="mostrarPanel('panel-estadisticas')">üìä Estad√≠sticas</button>
    </div>
    
    <!-- Panel: Vista Mensual -->
    <div id="panel-mes" class="panel active">
        <div class="mes-header">
            <h2 id="mes-actual">Enero 2025</h2>
            <div class="mes-header-buttons">
                <button onclick="cambiarMes(-1)">‚Üê Anterior</button>
                <button onclick="cambiarMes(0)">Hoy</button>
                <button onclick="cambiarMes(1)">Siguiente ‚Üí</button>
            </div>
        </div>
        <div class="dias-semana">
            <div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div><div>Dom</div>
        </div>
        <div id="calendario-mes" class="dias-mes"></div>
    </div>
    
    <!-- Panel: Vista Semanal -->
    <div id="panel-semana" class="panel">
        <div class="mes-header">
            <h2 id="semana-actual">Semana 5, 2025</h2>
            <div class="mes-header-buttons">
                <button onclick="cambiarSemana(-1)">‚Üê Anterior</button>
                <button onclick="cambiarSemana(0)">Esta Semana</button>
                <button onclick="cambiarSemana(1)">Siguiente ‚Üí</button>
            </div>
        </div>
        <div id="calendario-semana"></div>
    </div>
    
    <!-- Panel: Vista Diaria - MEJORADO -->
    <div id="panel-dia" class="panel">
        <div class="day-header-container">
            <div class="day-header-top">
                <h3>Vista Diaria</h3>
                <input type="date" id="fecha-dia" onchange="cargarDia()" style="min-width: 180px;">
            </div>
            <div class="day-header-bottom">
                <button onclick="imprimirDia()" class="btn">üñ®Ô∏è Imprimir D√≠a</button>
                <button onclick="exportarHistorial()" class="btn">üíæ Exportar Historial</button>
                <button onclick="compartirTurnosDia()" class="btn">üì§ Compartir Turnos</button>
            </div>
        </div>
        <div id="lista-dia" class="lista-turnos"></div>
    </div>
    
    <!-- Panel: Nuevo Turno - CON TEL√âFONO -->
    <div id="panel-nuevo" class="panel">
        <h2>‚ûï Nuevo Turno</h2>
        <div class="form-group">
            <label>üê∂ Cliente/Perrito:</label>
            <input list="lista-clientes" id="cliente" placeholder="Escribe nombre o selecciona">
            <datalist id="lista-clientes"></datalist>
            <button onclick="guardarCliente()" class="btn" style="margin-top: 10px; padding: 10px 15px;">üíæ Guardar Nuevo Cliente</button>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>üìû Tel√©fono:</label>
                <input type="tel" id="telefono" placeholder="Ej: 11 1234-5678">
            </div>
            <div class="form-group">
                <label>üìÖ Fecha y Hora:</label>
                <input type="datetime-local" id="fecha-hora" min="">
            </div>
        </div>
        
        <div class="form-group">
            <label>‚úÇÔ∏è Servicio:</label>
            <textarea id="servicio" rows="3" placeholder="Ej: Corte de pelo, ba√±o con perfume, corte de u√±as, etc."></textarea>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>üí∞ Precio:</label>
                <input type="number" id="precio" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label>üí≥ M√©todo de Pago:</label>
                <select id="metodo-pago">
                    <option value="efect">üíµ EFECTIVO</option>
                    <option value="mp">üü¢ MERCADO PAGO</option>
                    <option value="nx">üîµ TRANSFERENCIA</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label>üìù Notas adicionales:</label>
            <textarea id="notas" rows="2" placeholder="Observaciones o recordatorios..."></textarea>
        </div>
        
        <div class="form-group" id="fecha-error" style="display: none; color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 8px; border-left: 4px solid #d32f2f;">
            ‚ö†Ô∏è <strong>No se pueden agendar turnos en fechas pasadas.</strong> Por favor, selecciona una fecha y hora futura.
        </div>
        
        <button class="btn" onclick="guardarTurno()" style="width: 100%; padding: 18px; font-size: 1.1rem;">‚úÖ Guardar Turno</button>
    </div>
    
    <!-- Panel: Clientes -->
    <div id="panel-clientes" class="panel">
        <h2>üë• Clientes Registrados</h2>
        <div class="form-group">
            <input type="text" id="nuevo-cliente" placeholder="Nombre del cliente/perrito">
            <button onclick="agregarCliente()" class="btn" style="margin-top: 10px;">‚ûï Agregar Cliente</button>
        </div>
        <div id="lista-clientes-registrados"></div>
    </div>
    
    <!-- Panel: Estad√≠sticas -->
    <div id="panel-estadisticas" class="panel">
        <h2>üìä Estad√≠sticas Financieras</h2>
        <div class="stats">
            <div class="stat-box">
                <h3>Hoy</h3>
                <div class="valor" id="stats-hoy">$0</div>
            </div>
            <div class="stat-box">
                <h3>Esta Semana</h3>
                <div class="valor" id="stats-semana">$0</div>
            </div>
            <div class="stat-box">
                <h3>Este Mes</h3>
                <div class="valor" id="stats-mes">$0</div>
            </div>
            <div class="stat-box">
                <h3>Este A√±o</h3>
                <div class="valor" id="stats-anio">$0</div>
            </div>
        </div>
        <div class="stats">
            <div class="stat-box">
                <h3>üíµ EFECTIVO</h3>
                <div class="valor" id="stats-efect">$0</div>
            </div>
            <div class="stat-box">
                <h3>üü¢ MERCADO PAGO</h3>
                <div class="valor" id="stats-mp">$0</div>
            </div>
            <div class="stat-box">
                <h3>üîµ TRANSFERENCIA</h3>
                <div class="valor" id="stats-nx">$0</div>
            </div>
            <div class="stat-box">
                <h3>TOTAL GENERAL</h3>
                <div class="valor" id="stats-total">$0</div>
            </div>
        </div>
    </div>

    <script>
        // ====================
        // 1. DATOS Y ESTADO
        // ====================
        let turnos = JSON.parse(localStorage.getItem('turnos')) || [];
        let clientes = JSON.parse(localStorage.getItem('clientes')) || [];
        let mesActual = new Date().getMonth();
        let anioActual = new Date().getFullYear();
        let semanaActual = 0;
        let deferredPrompt = null;

        // ====================
        // 2. FUNCIONES CORE
        // ====================
        function guardarDatos() {
            localStorage.setItem('turnos', JSON.stringify(turnos));
            localStorage.setItem('clientes', JSON.stringify(clientes));
        }
        
        function mostrarPanel(id) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelector(`[onclick="mostrarPanel('${id}')"]`).classList.add('active');
            
            if (id === 'panel-mes') cargarMes();
            if (id === 'panel-semana') cargarSemana();
            if (id === 'panel-dia') cargarDia();
            if (id === 'panel-estadisticas') calcularEstadisticas();
            if (id === 'panel-clientes') cargarClientes();
        }

        // ====================
        // 3. VALIDACI√ìN DE FECHAS PASADAS
        // ====================
        function validarFechaFutura(fechaHora) {
            const ahora = new Date();
            const fechaSeleccionada = new Date(fechaHora);
            
            // Restamos 1 minuto para permitir turnos que empiecen "ahora"
            const ahoraMenosUnMinuto = new Date(ahora.getTime() - 60000);
            
            return fechaSeleccionada > ahoraMenosUnMinuto;
        }

        function mostrarErrorFecha() {
            const errorDiv = document.getElementById('fecha-error');
            errorDiv.style.display = 'block';
            errorDiv.classList.add('shake');
            
            // Tambi√©n hacer vibrar el campo de fecha
            const fechaInput = document.getElementById('fecha-hora');
            fechaInput.classList.add('shake');
            
            setTimeout(() => {
                errorDiv.classList.remove('shake');
                fechaInput.classList.remove('shake');
            }, 500);
            
            // Scroll al error
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function ocultarErrorFecha() {
            document.getElementById('fecha-error').style.display = 'none';
        }

        // ====================
        // 4. CALENDARIO MENSUAL
        // ====================
        function cargarMes() {
            const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", 
                          "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            document.getElementById('mes-actual').textContent = `${meses[mesActual]} ${anioActual}`;
            
            const primerDia = new Date(anioActual, mesActual, 1);
            const ultimoDia = new Date(anioActual, mesActual + 1, 0);
            const diasEnMes = ultimoDia.getDate();
            const primerDiaSemana = (primerDia.getDay() + 6) % 7;
            
            let html = '';
            for (let i = 0; i < primerDiaSemana; i++) {
                html += `<div class="dia"></div>`;
            }
            
            const hoy = new Date();
            const hoyString = hoy.toISOString().split('T')[0];
            
            for (let dia = 1; dia <= diasEnMes; dia++) {
                const fechaStr = `${anioActual}-${String(mesActual+1).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;
                const fechaDia = new Date(anioActual, mesActual, dia);
                const fechaDiaStr = fechaDia.toISOString().split('T')[0];
                
                let clases = 'dia';
                if (fechaDiaStr === hoyString) clases += ' hoy';
                
                // Marcar d√≠as pasados
                if (fechaDia < new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate())) {
                    clases += ' pasado';
                }
                
                const turnosDia = turnos.filter(t => t.fecha.split('T')[0] === fechaStr);
                if (turnosDia.length > 0) clases += ' con-turno';
                
                // Solo hacer clickable si no es d√≠a pasado
                const onClick = fechaDia < new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate()) 
                    ? '' 
                    : `onclick="cargarDiaEspecifico('${fechaStr}')"`;
                
                html += `<div class="${clases}" ${onClick}>
                           <div>${dia}</div>
                           ${turnosDia.length > 0 ? `<div class="turno-count">${turnosDia.length} turno${turnosDia.length > 1 ? 's' : ''}</div>` : ''}
                         </div>`;
            }
            
            document.getElementById('calendario-mes').innerHTML = html;
        }
        
        function cambiarMes(delta) {
            if (delta === 0) {
                const hoy = new Date();
                mesActual = hoy.getMonth();
                anioActual = hoy.getFullYear();
            } else {
                mesActual += delta;
                if (mesActual < 0) {
                    mesActual = 11;
                    anioActual--;
                } else if (mesActual > 11) {
                    mesActual = 0;
                    anioActual++;
                }
            }
            cargarMes();
        }

        // ====================
        // 5. VISTA SEMANAL
        // ====================
        function cargarSemana() {
            const hoy = new Date();
            const semanaStart = new Date(hoy);
            semanaStart.setDate(hoy.getDate() - hoy.getDay() + 1 + (semanaActual * 7));
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">';
            for (let i = 0; i < 7; i++) {
                const dia = new Date(semanaStart);
                dia.setDate(semanaStart.getDate() + i);
                const fechaStr = dia.toISOString().split('T')[0];
                
                const turnosDia = turnos.filter(t => t.fecha.split('T')[0] === fechaStr);
                
                const esHoy = fechaStr === new Date().toISOString().split('T')[0];
                const esPasado = dia < new Date(new Date().setHours(0,0,0,0));
                
                const estiloFondo = esPasado ? '#f5f5f5' : (esHoy ? '#fff3e0' : 'white');
                const estiloBorde = esPasado ? '#ddd' : '#ffccd5';
                const textoPasado = esPasado ? '<span style="color:#9e9e9e; font-size:0.9rem;"> (PASADO)</span>' : '';
                
                html += `<div style="border:1px solid ${estiloBorde}; padding:15px; border-radius:10px; background:${estiloFondo};">
                           <strong style="color:#5d4037; font-size:1.1rem;">${formatearFechaCorta(dia)}</strong>
                           ${esHoy ? '<span style="color:#ff7043; font-size:0.9rem;"> (HOY)</span>' : ''}
                           ${textoPasado}
                           <div style="margin-top:10px;">
                           ${turnosDia.length > 0 ? turnosDia.map(t => `
                             <div style="margin:10px 0; padding:10px; background:#f5f5f5; border-radius:8px; border-left:4px solid #ffab91;">
                               <div style="font-weight:bold;">üê∂ ${t.cliente}</div>
                               <div>‚è∞ ${t.hora}</div>
                               <div>‚úÇÔ∏è ${t.servicio.substring(0,25)}${t.servicio.length > 25 ? '...' : ''}</div>
                               <div>üí∞ $${t.precio} <span class="tag-pago ${t.metodo}">${t.metodo.toUpperCase()}</span></div>
                             </div>
                           `).join('') : '<div style="text-align:center; color:#8d6e63; padding:20px;">Sin turnos</div>'}
                           </div>
                         </div>`;
            }
            html += '</div>';
            
            document.getElementById('calendario-semana').innerHTML = html;
            document.getElementById('semana-actual').textContent = `Semana ${getSemanaDelAnio(semanaStart)}, ${semanaStart.getFullYear()}`;
        }
        
        function cambiarSemana(delta) {
            semanaActual += delta;
            cargarSemana();
        }
        
        function getSemanaDelAnio(fecha) {
            const primerDiaAnio = new Date(fecha.getFullYear(), 0, 1);
            const dias = Math.floor((fecha - primerDiaAnio) / (24 * 60 * 60 * 1000));
            return Math.ceil((dias + primerDiaAnio.getDay() + 1) / 7);
        }

        // ====================
        // 6. VISTA DIARIA
        // ====================
        function cargarDia(fecha = null) {
            const inputFecha = document.getElementById('fecha-dia');
            const fechaObj = fecha ? new Date(fecha) : new Date(inputFecha.value || new Date());
            const fechaStr = fechaObj.toISOString().split('T')[0];
            
            inputFecha.value = fechaStr;
            
            const turnosDia = turnos.filter(t => t.fecha.split('T')[0] === fechaStr)
                                   .sort((a,b) => a.hora.localeCompare(b.hora));
            
            const hoy = new Date().toISOString().split('T')[0];
            const esHoy = fechaStr === hoy;
            const esPasado = fechaObj < new Date(new Date().setHours(0,0,0,0));
            
            let html = `<h3 style="color:#5d4037; margin-bottom:20px;">${formatearFecha(fechaObj)}`;
            html += esHoy ? ' <span style="color:#ff7043">(HOY)</span>' : '';
            html += esPasado ? ' <span style="color:#9e9e9e">(PASADO)</span>' : '';
            html += '</h3>';
            
            if (turnosDia.length === 0) {
                html += '<div style="text-align:center; padding:40px; color:#8d6e63; background:#f9f9f9; border-radius:10px;">';
                html += '<div style="font-size:48px; margin-bottom:20px;">üêï</div>';
                html += '<p style="font-size:1.2rem;">No hay turnos programados para este d√≠a.</p>';
                if (esPasado) {
                    html += '<p style="margin-top:10px; color:#ff7043;">‚ö†Ô∏è Este d√≠a ya pas√≥</p>';
                } else {
                    html += '<p style="margin-top:10px;">¬°Agrega un nuevo turno haciendo clic en "Nuevo Turno"!</p>';
                }
                html += '</div>';
            } else {
                const totalDia = turnosDia.reduce((sum, t) => sum + (t.precio || 0), 0);
                html += `<p style="margin-bottom:20px; color:#8d6e63; font-size:1.1rem;">
                           üìä <strong>Resumen del d√≠a:</strong> ${turnosDia.length} turno${turnosDia.length !== 1 ? 's' : ''} - Total: <strong>$${totalDia.toFixed(2)}</strong>
                         </p>`;
                
                if (esPasado) {
                    html += `<div style="background:#fff3e0; padding:10px; border-radius:8px; margin-bottom:20px; border-left:4px solid #ff9800;">
                               ‚ö†Ô∏è <strong>D√≠a pasado</strong> - Los turnos de d√≠as pasados son solo para consulta.
                            </div>`;
                }
                
                turnosDia.forEach(t => {
                    const claseHoy = esHoy ? 'hoy' : '';
                    const telefono = t.telefono || 'No registrado';
                    const notas = t.notas ? `<div class="notas-info"><strong>üìù Notas:</strong> ${t.notas}</div>` : '';
                    
                    html += `
                        <div class="turno-item ${claseHoy}">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap;">
                                <div><strong style="font-size:1.2rem;">üê∂ ${t.cliente}</strong></div>
                                <div><span class="tag-pago ${t.metodo}">${t.metodo.toUpperCase()}</span></div>
                            </div>
                            <div class="telefono-info">
                                <span>üìû</span>
                                <span>${telefono}</span>
                            </div>
                            <div style="margin-bottom:10px;"><strong>‚è∞ Hora:</strong> ${t.hora}</div>
                            <div style="margin-bottom:10px;"><strong>‚úÇÔ∏è Servicio:</strong> ${t.servicio}</div>
                            ${notas}
                            <div style="margin-bottom:15px;"><strong>üí∞ Precio:</strong> $${t.precio.toFixed(2)}</div>
                            <div class="action-buttons">
                                ${!esPasado ? `
                                <button class="whatsapp-btn" onclick="enviarWhatsApp(${t.id})">
                                    <span>üì±</span> WhatsApp
                                </button>
                                <button class="share-btn" onclick="compartirTurno(${t.id})">
                                    <span>üì§</span> Compartir
                                </button>
                                <button class="edit-btn" onclick="editarTurno(${t.id})">
                                    <span>‚úèÔ∏è</span> Editar
                                </button>
                                ` : ''}
                                <button class="delete-btn" onclick="eliminarTurno(${t.id})">
                                    <span>üóëÔ∏è</span> Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('lista-dia').innerHTML = html;
        }
        
        function cargarDiaEspecifico(fechaStr) {
            const fechaObj = new Date(fechaStr);
            const hoy = new Date();
            hoy.setHours(0,0,0,0);
            
            if (fechaObj < hoy) {
                alert('‚ö†Ô∏è Este d√≠a ya pas√≥. Puedes ver los turnos pero no modificarlos.');
            }
            
            mostrarPanel('panel-dia');
            setTimeout(() => cargarDia(fechaStr), 100);
        }

        // ====================
        // 7. GESTION TURNOS - CON VALIDACI√ìN DE FECHAS PASADAS
        // ====================
        function guardarTurno() {
            const cliente = document.getElementById('cliente').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const fechaHora = document.getElementById('fecha-hora').value;
            const servicio = document.getElementById('servicio').value.trim();
            const precio = parseFloat(document.getElementById('precio').value) || 0;
            const metodo = document.getElementById('metodo-pago').value;
            const notas = document.getElementById('notas').value.trim();
            
            // Validar campos obligatorios
            if (!cliente || !fechaHora || !servicio) {
                alert('Por favor, completa los campos obligatorios: Cliente, Fecha/Hora y Servicio.');
                return;
            }
            
            // Validar que no sea fecha pasada
            if (!validarFechaFutura(fechaHora)) {
                mostrarErrorFecha();
                return;
            }
            
            ocultarErrorFecha();
            
            const nuevoTurno = {
                id: Date.now(),
                cliente: cliente,
                telefono: telefono,
                fecha: fechaHora,
                hora: fechaHora.split('T')[1].substring(0,5),
                servicio: servicio,
                precio: precio,
                metodo: metodo,
                notas: notas,
                fechaCreacion: new Date().toISOString()
            };
            
            turnos.push(nuevoTurno);
            
            if (!clientes.includes(cliente)) {
                clientes.push(cliente);
                guardarDatos();
                cargarListaClientes();
            }
            
            guardarDatos();
            
            // Limpiar formulario
            document.getElementById('cliente').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('fecha-hora').value = '';
            document.getElementById('servicio').value = '';
            document.getElementById('precio').value = '';
            document.getElementById('notas').value = '';
            
            alert('‚úÖ Turno guardado exitosamente!');
            mostrarPanel('panel-dia');
            cargarDia(fechaHora.split('T')[0]);
            cargarMes();
        }
        
        function editarTurno(id) {
            const turno = turnos.find(t => t.id === id);
            if (!turno) return;
            
            // Verificar si el turno es pasado
            const fechaTurno = new Date(turno.fecha);
            const ahora = new Date();
            
            if (fechaTurno < ahora) {
                if (!confirm('‚ö†Ô∏è Este turno ya pas√≥. ¬øDeseas editarlo de todos modos?\n\nNormalmente no se editan turnos pasados.')) {
                    return;
                }
            }
            
            document.getElementById('cliente').value = turno.cliente;
            document.getElementById('telefono').value = turno.telefono || '';
            document.getElementById('fecha-hora').value = turno.fecha;
            document.getElementById('servicio').value = turno.servicio;
            document.getElementById('precio').value = turno.precio;
            document.getElementById('metodo-pago').value = turno.metodo;
            document.getElementById('notas').value = turno.notas || '';
            
            eliminarTurno(id, false);
            mostrarPanel('panel-nuevo');
        }
        
        function eliminarTurno(id, confirmar = true) {
            if (confirmar && !confirm('¬øEst√°s seguro de eliminar este turno?')) return;
            
            turnos = turnos.filter(t => t.id !== id);
            guardarDatos();
            cargarDia();
            cargarMes();
        }

        // ====================
        // 8. FUNCIONES WHATSAPP Y COMPARTIR
        // ====================
        function enviarWhatsApp(turnoId) {
            const turno = turnos.find(t => t.id === turnoId);
            if (!turno) return;
            
            // Verificar si el turno es pasado
            const fechaTurno = new Date(turno.fecha);
            const ahora = new Date();
            
            if (fechaTurno < ahora) {
                if (!confirm('‚ö†Ô∏è Este turno ya pas√≥. ¬øDeseas enviar el recordatorio de todos modos?')) {
                    return;
                }
            }
            
            const telefono = turno.telefono || '';
            const telefonoLimpio = telefono.replace(/\D/g, '');
            
            const fecha = new Date(turno.fecha);
            const fechaFormateada = fecha.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const mensaje = `*Recordatorio de turno - Peluquer√≠a Canina Pati-pet*%0A%0A` +
                           `*Cliente:* ${turno.cliente}%0A` +
                           `*Fecha:* ${fechaFormateada}%0A` +
                           `*Hora:* ${turno.hora}%0A` +
                           `*Servicio:* ${turno.servicio}%0A` +
                           `*Precio:* $${turno.precio.toFixed(2)}%0A` +
                           (turno.notas ? `*Notas:* ${turno.notas}%0A` : '') +
                           `%0A¬°Esperamos verte pronto! üêæ`;
            
            let urlWhatsApp;
            if (telefonoLimpio) {
                urlWhatsApp = `https://wa.me/${telefonoLimpio}?text=${mensaje}`;
            } else {
                urlWhatsApp = `https://wa.me/?text=${mensaje}`;
                alert('No hay tel√©fono registrado. Se abrir√° WhatsApp sin n√∫mero espec√≠fico.');
            }
            
            window.open(urlWhatsApp, '_blank');
        }
        
        function compartirTurno(turnoId) {
            const turno = turnos.find(t => t.id === turnoId);
            if (!turno) return;
            
            const fecha = new Date(turno.fecha);
            const fechaFormateada = fecha.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const texto = `Turno agendado - Peluquer√≠a Canina Pati-pet\n\n` +
                         `Cliente: ${turno.cliente}\n` +
                         `Fecha: ${fechaFormateada}\n` +
                         `Hora: ${turno.hora}\n` +
                         `Servicio: ${turno.servicio}\n` +
                         `Precio: $${turno.precio.toFixed(2)}\n` +
                         (turno.notas ? `Notas: ${turno.notas}\n` : '') +
                         `\n¬°Gracias por confiar en Pati-pet! üêæ`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Turno Peluquer√≠a Canina Pati-pet',
                    text: texto,
                    url: window.location.href
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(texto).then(() => {
                    alert('‚úÖ Informaci√≥n del turno copiada al portapapeles. Puedes pegarla en WhatsApp o cualquier otra app.');
                }).catch(() => {
                    const textArea = document.createElement('textarea');
                    textArea.value = texto;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('‚úÖ Informaci√≥n del turno copiada al portapapeles.');
                });
            }
        }
        
        function compartirTurnosDia() {
            const fechaInput = document.getElementById('fecha-dia').value;
            const fecha = new Date(fechaInput);
            const turnosDia = turnos.filter(t => t.fecha.split('T')[0] === fechaInput)
                                   .sort((a,b) => a.hora.localeCompare(b.hora));
            
            if (turnosDia.length === 0) {
                alert('No hay turnos para compartir en esta fecha.');
                return;
            }
            
            const fechaFormateada = fecha.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let texto = `*Turnos del d√≠a - ${fechaFormateada} - Peluquer√≠a Canina Pati-pet*%0A%0A`;
            texto += `*Total de turnos:* ${turnosDia.length}%0A%0A`;
            
            turnosDia.forEach((t, index) => {
                texto += `*Turno ${index + 1}:*%0A`;
                texto += `üë§ ${t.cliente}%0A`;
                texto += `‚è∞ ${t.hora}%0A`;
                texto += `‚úÇÔ∏è ${t.servicio}%0A`;
                texto += `üí∞ $${t.precio.toFixed(2)}%0A`;
                if (t.telefono) texto += `üìû ${t.telefono}%0A`;
                texto += `---%0A`;
            });
            
            texto += `%0ATotal del d√≠a: *$${turnosDia.reduce((sum, t) => sum + t.precio, 0).toFixed(2)}*`;
            
            const urlWhatsApp = `https://wa.me/?text=${texto}`;
            window.open(urlWhatsApp, '_blank');
        }

        // ====================
        // 9. GESTION CLIENTES
        // ====================
        function cargarListaClientes() {
            const datalist = document.getElementById('lista-clientes');
            datalist.innerHTML = clientes.map(c => `<option value="${c}">`).join('');
        }
        
        function cargarClientes() {
            const lista = document.getElementById('lista-clientes-registrados');
            if (clientes.length === 0) {
                lista.innerHTML = '<div style="text-align:center; padding:30px; color:#8d6e63; background:#f9f9f9; border-radius:10px;">No hay clientes registrados a√∫n.</div>';
                return;
            }
            
            lista.innerHTML = clientes.map(c => {
                const turnosCliente = turnos.filter(t => t.cliente === c);
                const ultimoTurno = turnosCliente.length > 0 
                    ? new Date(turnosCliente[turnosCliente.length-1].fecha).toLocaleDateString('es-ES')
                    : 'Sin turnos';
                    
                return `
                <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
                    <div>
                        <div style="font-weight:bold; font-size:1.1rem;">üê∂ ${c}</div>
                        <div style="font-size:0.9rem; color:#8d6e63;">
                            ${turnosCliente.length} turno${turnosCliente.length !== 1 ? 's' : ''} - √öltimo: ${ultimoTurno}
                        </div>
                    </div>
                    <button onclick="eliminarCliente('${c}')" style="padding:8px 15px; background:#ffcdd2; color:#c62828; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">Eliminar</button>
                </div>
            `}).join('');
        }
        
        function guardarCliente() {
            const clienteInput = document.getElementById('cliente');
            const nombre = clienteInput.value.trim();
            
            if (!nombre) {
                alert('Por favor, escribe un nombre para el cliente.');
                return;
            }
            
            if (!clientes.includes(nombre)) {
                clientes.push(nombre);
                guardarDatos();
                cargarListaClientes();
                alert('‚úÖ Cliente guardado exitosamente!');
            }
        }
        
        function agregarCliente() {
            const input = document.getElementById('nuevo-cliente');
            const nombre = input.value.trim();
            
            if (!nombre) {
                alert('Por favor, escribe un nombre para el cliente.');
                return;
            }
            
            if (!clientes.includes(nombre)) {
                clientes.push(nombre);
                guardarDatos();
                cargarListaClientes();
                cargarClientes();
                input.value = '';
                alert('‚úÖ Cliente agregado exitosamente!');
            } else {
                alert('El cliente ya existe en la lista.');
            }
        }
        
        function eliminarCliente(nombre) {
            if (!confirm(`¬øEst√°s seguro de eliminar al cliente "${nombre}"?\nEsta acci√≥n tambi√©n eliminar√° todos sus turnos registrados.`)) return;
            
            clientes = clientes.filter(c => c !== nombre);
            turnos = turnos.filter(t => t.cliente !== nombre);
            guardarDatos();
            cargarClientes();
            cargarListaClientes();
            cargarMes();
            alert(`Cliente "${nombre}" eliminado.`);
        }

        // ====================
        // 10. ESTADISTICAS
        // ====================
        function calcularEstadisticas() {
            const hoy = new Date().toISOString().split('T')[0];
            const estaSemana = getSemanaDelAnio(new Date());
            const esteMes = new Date().getMonth();
            const esteAnio = new Date().getFullYear();
            
            const turnosHoy = turnos.filter(t => t.fecha.split('T')[0] === hoy);
            const turnosSemana = turnos.filter(t => getSemanaDelAnio(new Date(t.fecha)) === estaSemana);
            const turnosMes = turnos.filter(t => new Date(t.fecha).getMonth() === esteMes);
            const turnosAnio = turnos.filter(t => new Date(t.fecha).getFullYear() === esteAnio);
            
            const suma = (arr, metodo = null) => {
                const filtrados = metodo ? arr.filter(t => t.metodo === metodo) : arr;
                return filtrados.reduce((sum, t) => sum + (t.precio || 0), 0);
            };
            
            document.getElementById('stats-hoy').textContent = `$${suma(turnosHoy).toFixed(2)}`;
            document.getElementById('stats-semana').textContent = `$${suma(turnosSemana).toFixed(2)}`;
            document.getElementById('stats-mes').textContent = `$${suma(turnosMes).toFixed(2)}`;
            document.getElementById('stats-anio').textContent = `$${suma(turnosAnio).toFixed(2)}`;
            
            document.getElementById('stats-efect').textContent = `$${suma(turnos, 'efect').toFixed(2)}`;
            document.getElementById('stats-mp').textContent = `$${suma(turnos, 'mp').toFixed(2)}`;
            document.getElementById('stats-nx').textContent = `$${suma(turnos, 'nx').toFixed(2)}`;
            document.getElementById('stats-total').textContent = `$${suma(turnos).toFixed(2)}`;
        }

        // ====================
        // 11. EXPORTACION
        // ====================
        function imprimirDia() {
            const contenido = document.getElementById('lista-dia').innerHTML;
            const ventana = window.open('', '_blank');
            ventana.document.write(`
                <html><head><title>Turnos del D√≠a - Peluquer√≠a Canina Pati-pet</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    .turno-item { border:1px solid #ccc; padding:15px; margin-bottom:10px; border-radius:8px; }
                    h1 { color: #5d4037; }
                </style>
                </head>
                <body>
                <h1>Peluquer√≠a Canina Pati-pet</h1>
                <h2>Turnos del D√≠a</h2>
                ${contenido}
                <p style="margin-top:30px; text-align:center; color:#666;">Impreso el ${new Date().toLocaleDateString('es-ES')}</p>
                </body></html>
            `);
            ventana.document.close();
            ventana.print();
        }
        
        function exportarHistorial() {
            const datos = {
                clientes: clientes,
                turnos: turnos,
                exportado: new Date().toISOString(),
                sistema: "Peluquer√≠a Canina Pati-pet"
            };
            
            const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-pati-pet-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            alert('‚úÖ Historial exportado exitosamente!');
        }

        // ====================
        // 12. UTILIDADES
        // ====================
        function formatearFecha(fecha) {
            const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return fecha.toLocaleDateString('es-ES', opciones);
        }
        
        function formatearFechaCorta(fecha) {
            const opciones = { weekday: 'short', month: 'short', day: 'numeric' };
            return fecha.toLocaleDateString('es-ES', opciones);
        }

        // ====================
        // 13. PWA - INSTALAR APP
        // ====================
        function mostrarBannerInstalacion() {
            const installBanner = document.getElementById('installBanner');
            installBanner.classList.add('show');
            
            // Ocultar despu√©s de 30 segundos
            setTimeout(() => {
                installBanner.classList.remove('show');
            }, 30000);
        }
        
        function ocultarBannerInstalacion() {
            document.getElementById('installBanner').classList.remove('show');
        }
        
        // ====================
        // 14. SERVICE WORKER Y OFFLINE
        // ====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado con √©xito:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Error al registrar Service Worker:', error);
                    });
            });
        }
        
        // Detectar cambios en la conexi√≥n
        function actualizarEstadoConexion() {
            const offlineIndicator = document.getElementById('offlineIndicator');
            if (!navigator.onLine) {
                offlineIndicator.classList.add('show');
                console.log('Modo offline activado');
            } else {
                offlineIndicator.classList.remove('show');
                console.log('Modo online activado');
            }
        }
        
        // ====================
        // 15. INICIALIZACION
        // ====================
        document.addEventListener('DOMContentLoaded', () => {
            cargarListaClientes();
            cargarMes();
            cargarSemana();
            cargarDia();
            calcularEstadisticas();
            
            // Establecer valores por defecto en formularios
            const ahora = new Date();
            const fechaHora = new Date(ahora.getTime() - (ahora.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            const fechaHoraInput = document.getElementById('fecha-hora');
            fechaHoraInput.value = fechaHora;
            fechaHoraInput.min = new Date().toISOString().slice(0, 16);
            
            document.getElementById('fecha-dia').value = ahora.toISOString().split('T')[0];
            
            // Configurar detecci√≥n de cambio en fecha
            fechaHoraInput.addEventListener('change', function() {
                if (!validarFechaFutura(this.value)) {
                    mostrarErrorFecha();
                    this.focus();
                } else {
                    ocultarErrorFecha();
                }
            });
            
            // Eventos para PWA
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                mostrarBannerInstalacion();
            });
            
            document.getElementById('installBtn').addEventListener('click', () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('Usuario instal√≥ la app');
                        }
                        deferredPrompt = null;
                        ocultarBannerInstalacion();
                    });
                }
            });
            
            document.getElementById('closeInstall').addEventListener('click', ocultarBannerInstalacion);
            
            // Detectar estado de conexi√≥n
            window.addEventListener('online', actualizarEstadoConexion);
            window.addEventListener('offline', actualizarEstadoConexion);
            actualizarEstadoConexion();
        });
        // ====================
 
    </script>
</body>

</html>
