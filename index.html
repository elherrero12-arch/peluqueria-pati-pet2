<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#ffab91">
  <title>Patipet - Agenda Profesional</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./icon-192.png">
  
  <style>
    /* ===== RESET Y BASE ===== */
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif; 
      background: linear-gradient(135deg, #f9f7ff 0%, #e3f2fd 100%);
      color: #333;
      min-height: 100vh;
      padding: 15px;
    }
    
    /* ===== ENCABEZADO ===== */
    .header-container {
      text-align: center;
      margin: 0 auto 20px;
      padding: 20px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 102, 204, 0.1);
      max-width: 100%;
      border: 2px solid #ffccd5;
    }
    
    .paws-row {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 8px 0;
      font-size: 20px;
    }
    
    .main-title {
      font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
      color: #5d4037;
      font-size: 1.8rem;
      margin: 8px 0;
    }
    
    .subtitle {
      color: #8d6e63;
      font-size: 1rem;
      font-style: italic;
      margin-bottom: 8px;
    }
    
    /* ===== NAVEGACI√ìN ===== */
    .nav-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .nav { 
      display: flex; 
      background: #5d4037;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(93, 64, 55, 0.2);
    }
    
    .nav button { 
      flex: 1; 
      padding: 16px 8px; 
      border: none; 
      background: #8d6e63; 
      color: white; 
      cursor: pointer; 
      font-weight: bold;
      font-size: 13px;
      transition: all 0.3s ease;
    }
    
    .nav button:hover { 
      background: #a1887f; 
    }
    
    .nav button.active { 
      background: #ffab91; 
      color: #5d4037;
      box-shadow: inset 0 -3px 0 #ff8a65;
    }
    
    /* ===== BARRA DE BACKUP ===== */
    .barra-backup {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 10px;
      flex-wrap: wrap;
    }
    
    .barra-backup small {
      color: #666;
      font-size: 12px;
      margin-right: 5px;
    }
    
    .boton-backup {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
      color: white;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .boton-exportar { background: #4caf50; }
    .boton-importar { background: #2196f3; }
    .boton-refresh { background: #ff9800; }
    
    .boton-exportar:hover { background: #45a049; }
    .boton-importar:hover { background: #0b7dda; }
    .boton-refresh:hover { background: #f57c00; }
    
    /* ===== PANELES PRINCIPALES ===== */
    .panel { 
      display: none; 
      background: white; 
      padding: 20px; 
      border-radius: 15px; 
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      border: 1px solid #e0e0e0;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    .panel.active { 
      display: block; 
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* ===== CALENDARIO MENSUAL ===== */
    .mes-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #ffccd5;
    }
    
    .mes-header h2 {
      color: #5d4037;
      font-size: 1.5rem;
    }
    
    .mes-header-buttons {
      display: flex;
      gap: 8px;
    }
    
    .mes-header-buttons button {
      padding: 8px 15px;
      background: #ffccd5;
      color: #5d4037;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .mes-header-buttons button:hover {
      background: #ffab91;
    }
    
    .dias-semana { 
      display: grid; 
      grid-template-columns: repeat(7, 1fr); 
      text-align: center; 
      font-weight: bold; 
      margin-bottom: 10px;
      color: #8d6e63;
      padding: 10px 0;
      background: #f5f5f5;
      border-radius: 8px;
    }
    
    .dias-mes { 
      display: grid; 
      grid-template-columns: repeat(7, 1fr); 
      gap: 6px; 
      min-height: 500px;
    }
    
    .dia { 
      padding: 8px 4px; 
      border: 1px solid #e0e0e0; 
      text-align: center; 
      cursor: pointer; 
      height: 85px;
      max-height: 85px;
      border-radius: 8px;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      position: relative;
      background: #fafafa;
      overflow: hidden;
    }
    
    .dia:hover { 
      background: #e3f2fd; 
      transform: scale(1.02);
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    
    .dia.hoy { 
      background: #ffe0b2; 
      border-color: #ffab91;
      font-weight: bold;
    }
    
    .dia.pasado {
      background: #f5f5f5;
      color: #9e9e9e;
      cursor: not-allowed;
    }
    
    .dia.con-turno { 
      background: #ffebee; 
    }
    
    .dia-numero {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 4px;
      color: #5d4037;
    }
    
    .turnos-container {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      max-height: 55px;
    }
    
    .turno-en-casillero {
      font-size: 9px;
      line-height: 1.2;
      margin: 2px 0;
      padding: 2px 4px;
      background: rgba(255, 171, 145, 0.15);
      border-radius: 3px;
      border-left: 2px solid #ffab91;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .turno-count {
      position: absolute;
      bottom: 3px;
      right: 3px;
      font-size: 10px;
      color: #d32f2f;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      padding: 1px 6px;
      font-weight: bold;
    }
    
    /* ===== VISTA SEMANAL ===== */
    #calendario-semana {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .dia-semana {
      border: 1px solid #ffccd5;
      padding: 15px;
      border-radius: 10px;
      background: white;
    }
    
    .dia-semana.hoy {
      background: #fff3e0;
      border-color: #ffab91;
    }
    
    .dia-semana.pasado {
      background: #f5f5f5;
      border-color: #ddd;
    }
    
    /* ===== VISTA DIARIA ===== */
    .day-header-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .day-header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .day-header-bottom {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    /* ===== FORMULARIOS ===== */
    .form-group { 
      margin-bottom: 18px; 
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .form-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }
    
    label { 
      display: block; 
      margin-bottom: 6px; 
      font-weight: bold;
      color: #5d4037;
      font-size: 14px;
    }
    
    input, select, textarea { 
      width: 100%; 
      padding: 12px; 
      border: 1px solid #ccc; 
      border-radius: 8px; 
      font-size: 15px;
      transition: border 0.3s;
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: #ffab91;
      outline: none;
      box-shadow: 0 0 0 3px rgba(255, 171, 145, 0.2);
    }
    
    .btn { 
      background: linear-gradient(to right, #ffab91, #ff8a65); 
      color: white; 
      padding: 14px 22px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: bold;
      font-size: 15px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(255, 138, 101, 0.2);
    }
    
    .btn:hover { 
      background: linear-gradient(to right, #ff8a65, #ff7043); 
      transform: translateY(-2px);
      box-shadow: 0 6px 10px rgba(255, 138, 101, 0.3);
    }
    
    /* ===== LISTA DE TURNOS ===== */
    .lista-turnos { 
      margin-top: 20px; 
    }
    
    .turno-item { 
      border-left: 5px solid #ffab91; 
      padding: 18px; 
      margin-bottom: 15px; 
      background: #f9f9f9;
      border-radius: 0 10px 10px 0;
      transition: all 0.3s ease;
    }
    
    .turno-item:hover {
      transform: translateX(5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .turno-item.hoy { 
      border-left-color: #ff7043; 
      background: #fff3e0; 
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .action-buttons button {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      min-width: 100px;
      justify-content: center;
      font-size: 13px;
    }
    
    .edit-btn { background: #bbdefb; color: #1565c0; }
    .delete-btn { background: #ffcdd2; color: #c62828; }
    .whatsapp-btn { background: #25D366; color: white; }
    .share-btn { background: #FF9800; color: white; }
    
    .edit-btn:hover { background: #90caf9; }
    .delete-btn:hover { background: #ef9a9a; }
    .whatsapp-btn:hover { background: #128C7E; }
    .share-btn:hover { background: #F57C00; }
    
    /* ===== ESTAD√çSTICAS ===== */
    .stats { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
      gap: 15px; 
      margin: 20px 0; 
    }
    
    .stat-box { 
      background: white; 
      padding: 18px; 
      border-radius: 10px; 
      text-align: center; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      border-top: 5px solid #ffab91;
      transition: all 0.3s ease;
    }
    
    .stat-box:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }
    
    .stat-box h3 { 
      margin: 0 0 12px 0; 
      color: #8d6e63;
      font-size: 14px;
    }
    
    .stat-box .valor { 
      font-size: 24px; 
      font-weight: bold; 
      color: #5d4037; 
    }
    
    /* ===== OFFLINE Y INSTALACI√ìN ===== */
    .offline-indicator {
      display: none;
      background: #ff7043;
      color: white;
      padding: 10px;
      text-align: center;
      border-radius: 5px;
      margin-bottom: 15px;
      font-weight: bold;
    }
    
    .offline-indicator.show {
      display: block;
    }
    
    .install-banner {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 15px;
      max-width: 90%;
    }
    
    .install-banner.show {
      display: flex;
      animation: slideUp 0.5s ease;
    }
    
    @keyframes slideUp {
      from { transform: translateX(-50%) translateY(100px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    
    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .nav {
        flex-wrap: wrap;
      }
      
      .nav button {
        flex: 1 0 33%;
        padding: 14px 5px;
        font-size: 12px;
      }
      
      .stats {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .form-row {
        flex-direction: column;
        gap: 0;
      }
      
      .mes-header {
        flex-direction: column;
        gap: 15px;
      }
      
      .mes-header-buttons {
        width: 100%;
        justify-content: space-between;
      }
      
      .dias-mes {
        gap: 4px;
      }
      
      .dia {
        height: 75px;
        max-height: 75px;
        padding: 6px 3px;
      }
    }
    
    @media (max-width: 480px) {
      .stats {
        grid-template-columns: 1fr;
      }
      
      .nav button {
        flex: 1 0 50%;
        font-size: 11px;
      }
      
      .action-buttons button {
        min-width: calc(50% - 4px);
      }
      
      .panel {
        padding: 15px;
      }
      
      .main-title {
        font-size: 1.5rem;
      }
      
      .subtitle {
        font-size: 0.9rem;
      }
      
      .install-banner {
        flex-direction: column;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <!-- Indicador de conexi√≥n -->
  <div id="offlineIndicator" class="offline-indicator">
    ‚ö†Ô∏è Modo offline - Los datos se guardar√°n localmente
  </div>
  
  <!-- Banner para instalar app -->
  <div id="installBanner" class="install-banner">
    <span>üì± Instalar Patipet App para usar offline</span>
    <button id="installBtn" class="btn">Instalar</button>
    <button id="closeInstall" class="btn" style="background: #666;">‚úï</button>
  </div>
  
  <!-- Encabezado -->
  <div class="header-container">
    <div class="paws-row">
      <span>üêæ</span><span>üêæ</span><span>üêæ</span>
    </div>
    <h1 class="main-title">Patipet</h1>
    <div class="paws-row">
      <span>üêæ</span><span>üêæ</span><span>üêæ</span>
    </div>
    <p class="subtitle">Agenda Profesional para Mascotas</p>
    <p style="font-size: 0.85rem; color: #9e9e9e; margin-top: 5px;">
      üíæ Datos guardados localmente | üì± Usa offline
    </p>
  </div>
  
  <!-- Navegaci√≥n -->
  <div class="nav-container">
    <div class="nav">
      <button onclick="mostrarPanel('panel-mes')" class="active">üìÖ Mes</button>
      <button onclick="mostrarPanel('panel-semana')">üìã Semana</button>
      <button onclick="mostrarPanel('panel-dia')">üêï D√≠a</button>
      <button onclick="mostrarPanel('panel-nuevo')">‚ûï Nuevo</button>
      <button onclick="mostrarPanel('panel-clientes')">üë• Clientes</button>
      <button onclick="mostrarPanel('panel-estadisticas')">üìä Estad√≠sticas</button>
    </div>
    
    <!-- Barra de Backup -->
    <div class="barra-backup">
      <small>üíæ Backup:</small>
      <button class="boton-backup boton-exportar" onclick="exportarBackup()">
        üì• Exportar
      </button>
      <label class="boton-backup boton-importar">
        üì§ Importar
        <input type="file" accept=".json" onchange="importarBackup(event)" style="display: none;">
      </label>
      <button class="boton-backup boton-refresh" onclick="recargarAppConCacheClean()" title="Actualizar c√≥digo">
        üîÑ Actualizar App
      </button>
    </div>
  </div>
  
  <!-- Panel: Vista Mensual -->
  <div id="panel-mes" class="panel active">
    <div class="mes-header">
      <h2 id="mes-actual">Enero 2025</h2>
      <div class="mes-header-buttons">
        <button onclick="cambiarMes(-1)">‚Üê Anterior</button>
        <button onclick="cambiarMes(0)">Hoy</button>
        <button onclick="cambiarMes(1)">Siguiente ‚Üí</button>
      </div>
    </div>
    <div class="dias-semana">
      <div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div><div>Dom</div>
    </div>
    <div id="calendario-mes" class="dias-mes"></div>
  </div>
  
  <!-- Panel: Vista Semanal -->
  <div id="panel-semana" class="panel">
    <div class="mes-header">
      <h2 id="semana-actual">Semana 5, 2025</h2>
      <div class="mes-header-buttons">
        <button onclick="cambiarSemana(-1)">‚Üê Anterior</button>
        <button onclick="cambiarSemana(0)">Esta Semana</button>
        <button onclick="cambiarSemana(1)">Siguiente ‚Üí</button>
      </div>
    </div>
    <div id="calendario-semana"></div>
  </div>
  
  <!-- Panel: Vista Diaria -->
  <div id="panel-dia" class="panel">
    <div class="day-header-container">
      <div class="day-header-top">
        <h3>Vista Diaria</h3>
        <input type="date" id="fecha-dia" onchange="cargarDia()" style="min-width: 160px;">
      </div>
      <div class="day-header-bottom">
        <button onclick="imprimirDia()" class="btn">üñ®Ô∏è Imprimir D√≠a</button>
        <button onclick="compartirTurnosDia()" class="btn">üì§ Compartir Turnos</button>
      </div>
    </div>
    <div id="lista-dia" class="lista-turnos"></div>
  </div>
  
  <!-- Panel: Nuevo Turno -->
  <div id="panel-nuevo" class="panel">
    <h2>‚ûï Nuevo Turno</h2>
    <div class="form-group">
      <label>üê∂ Cliente/Perrito:</label>
      <input list="lista-clientes" id="cliente" placeholder="Escribe nombre o selecciona">
      <datalist id="lista-clientes"></datalist>
      <button onclick="guardarCliente()" class="btn" style="margin-top: 10px; padding: 10px 15px;">
        üíæ Guardar Nuevo Cliente
      </button>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label>üìû Tel√©fono:</label>
        <input type="tel" id="telefono" placeholder="Ej: 11 1234-5678">
      </div>
      <div class="form-group">
        <label>üìÖ Fecha:</label>
        <input type="date" id="fecha" min="">
      </div>
      <div class="form-group">
        <label>‚è∞ Hora:</label>
        <select id="hora">
          <option value="08:00">08:00</option>
          <option value="08:30">08:30</option>
          <option value="09:00">09:00</option>
          <option value="09:30">09:30</option>
          <option value="10:00">10:00</option>
          <option value="10:30">10:30</option>
          <option value="11:00">11:00</option>
          <option value="11:30">11:30</option>
          <option value="12:00">12:00</option>
          <option value="12:30">12:30</option>
          <option value="13:00">13:00</option>
          <option value="13:30">13:30</option>
          <option value="14:00">14:00</option>
          <option value="14:30">14:30</option>
          <option value="15:00">15:00</option>
          <option value="15:30">15:30</option>
          <option value="16:00">16:00</option>
          <option value="16:30">16:30</option>
          <option value="17:00">17:00</option>
          <option value="17:30">17:30</option>
          <option value="18:00">18:00</option>
          <option value="18:30">18:30</option>
          <option value="19:00">19:00</option>
        </select>
      </div>
    </div>
    
    <div class="form-group">
      <label>‚úÇÔ∏è Servicio:</label>
      <textarea id="servicio" rows="3" placeholder="Ej: Corte de pelo, ba√±o con perfume, corte de u√±as, etc."></textarea>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label>üí∞ Precio:</label>
        <input type="number" id="precio" placeholder="0.00" step="0.01">
      </div>
      <div class="form-group">
        <label>üí≥ M√©todo de Pago:</label>
        <select id="metodo-pago">
          <option value="efect">üíµ EFECTIVO</option>
          <option value="mp">üü¢ MERCADO PAGO</option>
          <option value="nx">üîµ TRANSFERENCIA</option>
        </select>
      </div>
    </div>
    
    <div class="form-group">
      <label>üìù Notas adicionales:</label>
      <textarea id="notas" rows="2" placeholder="Observaciones o recordatorios..."></textarea>
    </div>
    
    <div id="fecha-error" style="display: none; color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 8px; border-left: 4px solid #d32f2f;">
      ‚ö†Ô∏è <strong>No se pueden agendar turnos en fechas pasadas.</strong>
    </div>
    
    <button class="btn" onclick="guardarTurno()" style="width: 100%; padding: 16px; font-size: 1.1rem;">
      ‚úÖ Guardar Turno
    </button>
  </div>
  
  <!-- Panel: Clientes -->
  <div id="panel-clientes" class="panel">
    <h2>üë• Clientes Registrados</h2>
    <div class="form-group">
      <input type="text" id="nuevo-cliente" placeholder="Nombre del cliente/perrito">
      <button onclick="agregarCliente()" class="btn" style="margin-top: 10px;">
        ‚ûï Agregar Cliente
      </button>
    </div>
    <div id="lista-clientes-registrados"></div>
  </div>
  
  <!-- Panel: Estad√≠sticas -->
  <div id="panel-estadisticas" class="panel">
    <h2>üìä Estad√≠sticas Financieras</h2>
    <div class="stats">
      <div class="stat-box">
        <h3>Hoy</h3>
        <div class="valor" id="stats-hoy">$0</div>
      </div>
      <div class="stat-box">
        <h3>Esta Semana</h3>
        <div class="valor" id="stats-semana">$0</div>
      </div>
      <div class="stat-box">
        <h3>Este Mes</h3>
        <div class="valor" id="stats-mes">$0</div>
      </div>
      <div class="stat-box">
        <h3>Este A√±o</h3>
        <div class="valor" id="stats-anio">$0</div>
      </div>
    </div>
    <div class="stats">
      <div class="stat-box">
        <h3>üíµ EFECTIVO</h3>
        <div class="valor" id="stats-efect">$0</div>
      </div>
      <div class="stat-box">
        <h3>üü¢ MERCADO PAGO</h3>
        <div class="valor" id="stats-mp">$0</div>
      </div>
      <div class="stat-box">
        <h3>üîµ TRANSFERENCIA</h3>
        <div class="valor" id="stats-nx">$0</div>
      </div>
      <div class="stat-box">
        <h3>TOTAL GENERAL</h3>
        <div class="valor" id="stats-total">$0</div>
      </div>
    </div>
  </div>

  <script>
    // ====================
    // 1. DATOS Y ESTADO
    // ====================
    let turnos = JSON.parse(localStorage.getItem('turnos')) || [];
    let clientes = JSON.parse(localStorage.getItem('clientes')) || [];
    let mesActual = new Date().getMonth();
    let anioActual = new Date().getFullYear();
    let semanaActual = 0;
    let deferredPrompt = null;
    const BACKUP_KEY = 'patipet_backup_v1';

    // ====================
    // 2. FUNCIONES CORE
    // ====================
    function guardarDatos() {
      localStorage.setItem('turnos', JSON.stringify(turnos));
      localStorage.setItem('clientes', JSON.stringify(clientes));
    }
    
    function mostrarPanel(id) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelector(`[onclick="mostrarPanel('${id}')"]`).classList.add('active');
      
      if (id === 'panel-mes') cargarMes();
      if (id === 'panel-semana') cargarSemana();
      if (id === 'panel-dia') cargarDia();
      if (id === 'panel-estadisticas') calcularEstadisticas();
      if (id === 'panel-clientes') cargarClientes();
    }

    // ====================
    // 3. CALENDARIO MENSUAL
    // ====================
    function cargarMes() {
      const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", 
                    "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
      document.getElementById('mes-actual').textContent = `${meses[mesActual]} ${anioActual}`;
      
      const primerDia = new Date(anioActual, mesActual, 1);
      const ultimoDia = new Date(anioActual, mesActual + 1, 0);
      const diasEnMes = ultimoDia.getDate();
      const primerDiaSemana = (primerDia.getDay() + 6) % 7;
      
      let html = '';
      for (let i = 0; i < primerDiaSemana; i++) {
        html += `<div class="dia"></div>`;
      }
      
      const hoy = new Date();
      const hoyString = hoy.toISOString().split('T')[0];
      
      for (let dia = 1; dia <= diasEnMes; dia++) {
        const fechaStr = `${anioActual}-${String(mesActual+1).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;
        const fechaDia = new Date(anioActual, mesActual, dia);
        const fechaDiaStr = fechaDia.toISOString().split('T')[0];
        
        let clases = 'dia';
        if (fechaDiaStr === hoyString) clases += ' hoy';
        if (fechaDia < new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate())) clases += ' pasado';
        
        const turnosDia = turnos.filter(t => t.fecha.split('T')[0] === fechaStr);
        if (turnosDia.length > 0) clases += ' con-turno';
        
        const onClick = fechaDia < new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate()) 
          ? '' 
          : `onclick="cargarDiaEspecifico('${fechaStr}')"`;
        
        html += `<div class="${clases}" ${onClick}>
                   <div class="dia-numero">${dia}</div>
                   ${turnosDia.length > 0 ? `
                     <div class="turnos-container">
                       ${turnosDia.slice(0, 3).map(t => `
                         <div class="turno-en-casillero" title="${t.cliente} - ${t.servicio}">
                           ${t.hora} - ${t.cliente.substring(0, 10)}${t.cliente.length > 10 ? '...' : ''}
                         </div>
                       `).join('')}
                       ${turnosDia.length > 3 ? `<div style="font-size:8px; color:#666; text-align:center;">+${turnosDia.length - 3} m√°s</div>` : ''}
                     </div>
                   ` : ''}
                   ${turnosDia.length > 0 ? `<div class="turno-count">${turnosDia.length}</div>` : ''}
                 </div>`;
      }
      
      document.getElementById('calendario-mes').innerHTML = html;
    }
    
    function cambiarMes(delta) {
      if (delta === 0) {
        const hoy = new Date();
        mesActual = hoy.getMonth();
        anioActual = hoy.getFullYear();
      } else {
        mesActual += delta;
        if (mesActual < 0) {
          mesActual = 11;
          anioActual--;
        } else if (mesActual > 11) {
          mesActual = 0;
          anioActual++;
        }
      }
      cargarMes();
    }

    // ====================
    // 4. VISTA SEMANAL
    // ====================
    function cargarSemana() {
      const hoy = new Date();
      const semanaStart = new Date(hoy);
      semanaStart.setDate(hoy.getDate() - hoy.getDay() + 1 + (semanaActual * 7));
      
      let html = '';
      for (let i = 0; i < 7; i++) {
        const dia = new Date(semanaStart);
        dia.setDate(semanaStart.getDate() + i);
        const fechaStr = dia.toISOString().split('T')[0];
        
        const turnosDia = turnos.filter(t => t.fecha.split('T')[0] === fechaStr);
        const esHoy = fechaStr === new Date().toISOString().split('T')[0];
        const esPasado = dia < new Date(new Date().setHours(0,0,0,0));
        
        let claseDia = 'dia-semana';
        if (esHoy) claseDia += ' hoy';
        if (esPasado) claseDia += ' pasado';
        
        html += `<div class="${claseDia}">
                   <strong style="color:#5d4037; font-size:1.1rem;">
                     ${dia.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' })}
                   </strong>
                   ${esHoy ? '<span style="color:#ff7043; font-size:0.9rem;"> (HOY)</span>' : ''}
                   <div style="margin-top:10px;">
                     ${turnosDia.length > 0 ? turnosDia.map(t => `
                       <div style="margin:8px 0; padding:8px; background:#f5f5f5; border-radius:8px; border-left:4px solid #ffab91;">
                         <div><strong>üê∂ ${t.cliente}</strong></div>
                         <div>‚è∞ ${t.hora}</div>
                         <div>üí∞ $${t.precio}</div>
                       </div>
                     `).join('') : '<div style="text-align:center; color:#8d6e63; padding:15px;">Sin turnos</div>'}
                   </div>
                 </div>`;
      }
      
      document.getElementById('calendario-semana').innerHTML = html;
    }
    
    function cambiarSemana(delta) {
      semanaActual += delta;
      cargarSemana();
    }

    // ====================
    // 5. VISTA DIARIA
    // ====================
    function cargarDia(fecha = null) {
    const inputFecha = document.getElementById('fecha-dia');

    // üî• Construir fecha en hora LOCAL (evita el desfase UTC)
    let fechaObj;
    if (fecha) {
        const [anio, mes, dia] = fecha.split('-').map(Number);
        fechaObj = new Date(anio, mes - 1, dia);
    } else {
        const valor = inputFecha.value;
        if (valor) {
            const [anio, mes, dia] = valor.split('-').map(Number);
            fechaObj = new Date(anio, mes - 1, dia);
        } else {
            fechaObj = new Date();
        }
    }

    const fechaStr = fechaObj.toISOString().split('T')[0];
    inputFecha.value = fechaStr;

    const turnosDia = turnos
        .filter(t => t.fecha.split('T')[0] === fechaStr)
        .sort((a, b) => a.hora.localeCompare(b.hora));

    let html = `<h3 style="color:#5d4037; margin-bottom:15px;">
        ${fechaObj.toLocaleDateString('es-ES', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        })}
    </h3>`;

    if (turnosDia.length === 0) {
        html += '<div style="text-align:center; padding:30px; color:#8d6e63; background:#f9f9f9; border-radius:10px;">';
        html += '<div style="font-size:48px; margin-bottom:15px;">üêï</div>';
        html += '<p style="font-size:1.1rem;">No hay turnos programados para este d√≠a.</p>';
        html += '</div>';
    } else {
        turnosDia.forEach(t => {
            html += `
            <div class="turno-item">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div><strong style="font-size:1.2rem;">üê∂ ${t.cliente}</strong></div>
                    <div><span style="background:#ffab91; color:white; padding:4px 10px; border-radius:12px; font-size:12px;">${t.hora}</span></div>
                </div>
                <div style="margin-bottom:8px;"><strong>‚úÇÔ∏è Servicio:</strong> ${t.servicio}</div>
                <div style="margin-bottom:8px;"><strong>üí∞ Precio:</strong> $${t.precio.toFixed(2)}</div>
                ${t.telefono ? `<div style="margin-bottom:8px;"><strong>üìû Tel√©fono:</strong> ${t.telefono}</div>` : ''}
                ${t.notas ? `<div style="margin-bottom:15px;"><strong>üìù Notas:</strong> ${t.notas}</div>` : ''}
                <div class="action-buttons">
                    <button class="whatsapp-btn" onclick="enviarWhatsApp(${t.id})">
                        <span>üì±</span> WhatsApp
                    </button>
                    <button class="edit-btn" onclick="editarTurno(${t.id})">
                        <span>‚úèÔ∏è</span> Editar
                    </button>
                    <button class="delete-btn" onclick="eliminarTurno(${t.id})">
                        <span>üóëÔ∏è</span> Eliminar
                    </button>
                </div>
            </div>
            `;
        });
    }

    document.getElementById('lista-dia').innerHTML = html;
}
    
    function cargarDiaEspecifico(fechaStr) {
    const [anio, mes, dia] = fechaStr.split('-').map(Number);
    const fechaObj = new Date(anio, mes - 1, dia);

    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);

    if (fechaObj < hoy) {
        alert('‚ö†Ô∏è Este d√≠a ya pas√≥. Puedes ver los turnos pero no modificarlos.');
    }

    mostrarPanel('panel-dia');
    setTimeout(() => cargarDia(fechaStr), 100);
    }
    
    // ====================
    // 6. GESTI√ìN DE TURNOS
    // ====================
    function guardarTurno() {
      const cliente = document.getElementById('cliente').value.trim();
      const telefono = document.getElementById('telefono').value.trim();
      const fecha = document.getElementById('fecha').value;
      const hora = document.getElementById('hora').value;
      const servicio = document.getElementById('servicio').value.trim();
      const precio = parseFloat(document.getElementById('precio').value) || 0;
      const metodo = document.getElementById('metodo-pago').value;
      const notas = document.getElementById('notas').value.trim();
      
      if (!cliente || !fecha || !hora || !servicio) {
        alert('Por favor, completa los campos obligatorios: Cliente, Fecha, Hora y Servicio.');
        return;
      }
      
      const fechaHora = fecha + 'T' + hora;
      const ahora = new Date();
      const fechaSeleccionada = new Date(fechaHora);
      
      if (fechaSeleccionada <= ahora) {
        document.getElementById('fecha-error').style.display = 'block';
        setTimeout(() => document.getElementById('fecha-error').style.display = 'none', 3000);
        return;
      }
      
      const nuevoTurno = {
        id: Date.now(),
        cliente: cliente,
        telefono: telefono,
        fecha: fechaHora,
        hora: hora,
        servicio: servicio,
        precio: precio,
        metodo: metodo,
        notas: notas,
        fechaCreacion: new Date().toISOString()
      };
      
      turnos.push(nuevoTurno);
      
      if (!clientes.includes(cliente)) {
        clientes.push(cliente);
        guardarDatos();
        cargarListaClientes();
      }
      
      guardarDatos();
      alert('‚úÖ Turno guardado exitosamente!');
      
      // Limpiar formulario
      document.getElementById('cliente').value = '';
      document.getElementById('telefono').value = '';
      document.getElementById('servicio').value = '';
      document.getElementById('precio').value = '';
      document.getElementById('notas').value = '';
      
      mostrarPanel('panel-dia');
      cargarDia(fecha);
      cargarMes();
    }
    
    function editarTurno(id) {
      const turno = turnos.find(t => t.id === id);
      if (!turno) return;
      
      document.getElementById('cliente').value = turno.cliente;
      document.getElementById('telefono').value = turno.telefono || '';
      document.getElementById('fecha').value = turno.fecha.split('T')[0];
      document.getElementById('hora').value = turno.hora;
      document.getElementById('servicio').value = turno.servicio;
      document.getElementById('precio').value = turno.precio;
      document.getElementById('metodo-pago').value = turno.metodo;
      document.getElementById('notas').value = turno.notas || '';
      
      eliminarTurno(id, false);
      mostrarPanel('panel-nuevo');
    }
    
    function eliminarTurno(id, confirmar = true) {
      if (confirmar && !confirm('¬øEst√°s seguro de eliminar este turno?')) return;
      
      turnos = turnos.filter(t => t.id !== id);
      guardarDatos();
      cargarDia();
      cargarMes();
    }

    // ====================
    // 7. WHATSAPP Y COMPARTIR
    // ====================
    function enviarWhatsApp(turnoId) {
      const turno = turnos.find(t => t.id === turnoId);
      if (!turno) return;
      
      const telefono = turno.telefono || '';
      const telefonoLimpio = telefono.replace(/\D/g, '');
      
      const fecha = new Date(turno.fecha);
      const fechaFormateada = fecha.toLocaleDateString('es-ES', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      const mensaje = `*Recordatorio de turno - Patipet*%0A%0A` +
                     `*Cliente:* ${turno.cliente}%0A` +
                     `*Fecha:* ${fechaFormateada}%0A` +
                     `*Hora:* ${turno.hora}%0A` +
                     `*Servicio:* ${turno.servicio}%0A` +
                     `*Precio:* $${turno.precio.toFixed(2)}%0A` +
                     (turno.notas ? `*Notas:* ${turno.notas}%0A` : '') +
                     `%0A¬°Esperamos verte pronto! üêæ`;
      
      let urlWhatsApp;
      if (telefonoLimpio) {
        urlWhatsApp = `https://wa.me/${telefonoLimpio}?text=${mensaje}`;
      } else {
        urlWhatsApp = `https://wa.me/?text=${mensaje}`;
        alert('No hay tel√©fono registrado. Se abrir√° WhatsApp sin n√∫mero espec√≠fico.');
      }
      
      window.open(urlWhatsApp, '_blank');
    }
    
    function compartirTurnosDia() {
      const fechaInput = document.getElementById('fecha-dia').value;
      const fecha = new Date(fechaInput);
      const turnosDia = turnos.filter(t => t.fecha.split('T')[0] === fechaInput);
      
      if (turnosDia.length === 0) {
        alert('No hay turnos para compartir en esta fecha.');
        return;
      }
      
      const fechaFormateada = fecha.toLocaleDateString('es-ES', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      let texto = `*Turnos del d√≠a - ${fechaFormateada} - Patipet*%0A%0A`;
      texto += `*Total de turnos:* ${turnosDia.length}%0A%0A`;
      
      turnosDia.forEach((t, index) => {
        texto += `*Turno ${index + 1}:*%0A`;
        texto += `üë§ ${t.cliente}%0A`;
        texto += `‚è∞ ${t.hora}%0A`;
        texto += `‚úÇÔ∏è ${t.servicio}%0A`;
        texto += `üí∞ $${t.precio.toFixed(2)}%0A`;
        if (t.telefono) texto += `üìû ${t.telefono}%0A`;
        texto += `---%0A`;
      });
      
      const urlWhatsApp = `https://wa.me/?text=${texto}`;
      window.open(urlWhatsApp, '_blank');
    }

    // ====================
    // 8. GESTI√ìN DE CLIENTES
    // ====================
    function cargarListaClientes() {
      const datalist = document.getElementById('lista-clientes');
      datalist.innerHTML = clientes.map(c => `<option value="${c}">`).join('');
    }
    
    function cargarClientes() {
      const lista = document.getElementById('lista-clientes-registrados');
      if (clientes.length === 0) {
        lista.innerHTML = '<div style="text-align:center; padding:25px; color:#8d6e63; background:#f9f9f9; border-radius:10px;">No hay clientes registrados a√∫n.</div>';
        return;
      }
      
      lista.innerHTML = clientes.map(c => {
        const turnosCliente = turnos.filter(t => t.cliente === c);
        return `
          <div style="padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div style="font-weight:bold;">üê∂ ${c}</div>
              <div style="font-size:0.9rem; color:#8d6e63;">
                ${turnosCliente.length} turno${turnosCliente.length !== 1 ? 's' : ''}
              </div>
            </div>
            <button onclick="eliminarCliente('${c}')" style="padding:6px 12px; background:#ffcdd2; color:#c62828; border:none; border-radius:6px; cursor:pointer; font-size:12px;">
              Eliminar
            </button>
          </div>
        `;
      }).join('');
    }
    
    function guardarCliente() {
      const clienteInput = document.getElementById('cliente');
      const nombre = clienteInput.value.trim();
      
      if (!nombre) {
        alert('Por favor, escribe un nombre para el cliente.');
        return;
      }
      
      if (!clientes.includes(nombre)) {
        clientes.push(nombre);
        guardarDatos();
        cargarListaClientes();
        alert('‚úÖ Cliente guardado exitosamente!');
      }
    }
    
    function agregarCliente() {
      const input = document.getElementById('nuevo-cliente');
      const nombre = input.value.trim();
      
      if (!nombre) {
        alert('Por favor, escribe un nombre para el cliente.');
        return;
      }
      
      if (!clientes.includes(nombre)) {
        clientes.push(nombre);
        guardarDatos();
        cargarListaClientes();
        cargarClientes();
        input.value = '';
        alert('‚úÖ Cliente agregado exitosamente!');
      } else {
        alert('El cliente ya existe en la lista.');
      }
    }
    
    function eliminarCliente(nombre) {
      if (!confirm(`¬øEst√°s seguro de eliminar al cliente "${nombre}"?\nEsta acci√≥n tambi√©n eliminar√° todos sus turnos registrados.`)) return;
      
      clientes = clientes.filter(c => c !== nombre);
      turnos = turnos.filter(t => t.cliente !== nombre);
      guardarDatos();
      cargarClientes();
      cargarListaClientes();
      cargarMes();
      alert(`Cliente "${nombre}" eliminado.`);
    }

    // ====================
    // 9. ESTAD√çSTICAS
    // ====================
    function calcularEstadisticas() {
      const hoy = new Date().toISOString().split('T')[0];
      const esteMes = new Date().getMonth();
      const esteAnio = new Date().getFullYear();
      
      const turnosHoy = turnos.filter(t => t.fecha.split('T')[0] === hoy);
      const turnosMes = turnos.filter(t => new Date(t.fecha).getMonth() === esteMes);
      const turnosAnio = turnos.filter(t => new Date(t.fecha).getFullYear() === esteAnio);
      
      const suma = (arr, metodo = null) => {
        const filtrados = metodo ? arr.filter(t => t.metodo === metodo) : arr;
        return filtrados.reduce((sum, t) => sum + (t.precio || 0), 0);
      };
      
      document.getElementById('stats-hoy').textContent = `$${suma(turnosHoy).toFixed(2)}`;
      document.getElementById('stats-semana').textContent = `$${suma(turnos.filter(t => {
        const fechaTurno = new Date(t.fecha);
        const hoy = new Date();
        const inicioSemana = new Date(hoy.setDate(hoy.getDate() - hoy.getDay()));
        return fechaTurno >= inicioSemana;
      })).toFixed(2)}`;
      document.getElementById('stats-mes').textContent = `$${suma(turnosMes).toFixed(2)}`;
      document.getElementById('stats-anio').textContent = `$${suma(turnosAnio).toFixed(2)}`;
      
      document.getElementById('stats-efect').textContent = `$${suma(turnos, 'efect').toFixed(2)}`;
      document.getElementById('stats-mp').textContent = `$${suma(turnos, 'mp').toFixed(2)}`;
      document.getElementById('stats-nx').textContent = `$${suma(turnos, 'nx').toFixed(2)}`;
      document.getElementById('stats-total').textContent = `$${suma(turnos).toFixed(2)}`;
    }

    // ====================
    // 10. SISTEMA DE BACKUP
    // ====================
    function exportarBackup() {
      try {
        const datos = {
          turnos: turnos,
          clientes: clientes,
          exportado: new Date().toISOString(),
          version: 'patipet_v1'
        };
        
        const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup-patipet-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('‚úÖ Backup exportado correctamente');
      } catch (error) {
        alert('‚ùå Error al exportar: ' + error.message);
      }
    }

    function importarBackup(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const datos = JSON.parse(e.target.result);
          
          if (!datos.turnos || !Array.isArray(datos.turnos)) {
            throw new Error('Archivo de backup inv√°lido');
          }
          
          if (!confirm(`¬øRestaurar backup con ${datos.turnos.length} turnos y ${datos.clientes ? datos.clientes.length : 0} clientes?\n\nSe reemplazar√°n los datos actuales.`)) {
            return;
          }
          
          // Guardar backup actual por si acaso
          const backupActual = {
            turnos: JSON.parse(localStorage.getItem('turnos') || '[]'),
            clientes: JSON.parse(localStorage.getItem('clientes') || '[]'),
            fecha: new Date().toISOString()
          };
          localStorage.setItem('backup_antes_de_importar', JSON.stringify(backupActual));
          
          // Restaurar datos
          turnos = datos.turnos;
          clientes = datos.clientes || [];
          guardarDatos();
          
          // Recargar vistas
          cargarMes();
          cargarSemana();
          cargarDia();
          cargarListaClientes();
          cargarClientes();
          calcularEstadisticas();
          
          alert(`‚úÖ Backup restaurado\nTurnos: ${turnos.length}\nClientes: ${clientes.length}`);
          
        } catch (error) {
          alert('‚ùå Error al importar: ' + error.message);
        }
      };
      reader.readAsText(file);
    }

    // ====================
    // 11. ACTUALIZAR C√ìDIGO
    // ====================
    function recargarAppConCacheClean() {
      if (!confirm('¬øActualizar la aplicaci√≥n?\n\nEsto cargar√° la √∫ltima versi√≥n del c√≥digo.\n‚úÖ Tus datos NO se perder√°n.\nüîÑ La p√°gina se recargar√°.')) {
        return;
      }
      
      // Forzar actualizaci√≥n de Service Worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          registrations.forEach(registration => {
            registration.update();
          });
        });
      }
      
      // Recargar sin cach√©
      setTimeout(() => {
        window.location.reload(true);
      }, 500);
      
      alert('üîÑ Recargando aplicaci√≥n... Tus datos est√°n seguros.');
    }

    // ====================
    // 12. PWA Y SERVICE WORKER
    // ====================
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('Service Worker registrado:', registration.scope);
          })
          .catch(error => {
            console.log('Error al registrar Service Worker:', error);
          });
      });
    }

    // ====================
    // 13. INICIALIZACI√ìN
    // ====================
    document.addEventListener('DOMContentLoaded', () => {
      // Configurar fecha m√≠nima en formulario
      const hoy = new Date().toISOString().split('T')[0];
      document.getElementById('fecha').min = hoy;
      document.getElementById('fecha-dia').value = hoy;
      
      // Cargar datos iniciales
      cargarListaClientes();
      cargarMes();
      cargarSemana();
      cargarDia();
      calcularEstadisticas();
      
      // Configurar PWA
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        setTimeout(() => {
          document.getElementById('installBanner').classList.add('show');
        }, 2000);
      });
      
      document.getElementById('installBtn').addEventListener('click', () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              console.log('Usuario instal√≥ la app');
            }
            deferredPrompt = null;
            document.getElementById('installBanner').classList.remove('show');
          });
        }
      });
      
      document.getElementById('closeInstall').addEventListener('click', () => {
        document.getElementById('installBanner').classList.remove('show');
      });
      
      // Detectar estado de conexi√≥n
      window.addEventListener('online', () => {
        document.getElementById('offlineIndicator').classList.remove('show');
      });
      
      window.addEventListener('offline', () => {
        document.getElementById('offlineIndicator').classList.add('show');
      });
    });
  </script>
</body>
</html>

